# MaickelSMM - Configuration Apache
# Règles de sécurité et de redirection

# Activer la réécriture d'URL
RewriteEngine On

# Redirection HTTPS (décommentez si vous avez un certificat SSL)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Redirection www vers non-www (ou vice-versa selon votre préférence)
# RewriteCond %{HTTP_HOST} ^www\.(.*)$ [NC]
# RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

# Règles de réécriture pour les URLs propres
RewriteRule ^order/([0-9]+)/?$ order.php?id=$1 [L,QSA]
RewriteRule ^service/([0-9]+)/?$ service.php?id=$1 [L,QSA]
RewriteRule ^category/([0-9]+)/?$ category.php?id=$1 [L,QSA]
RewriteRule ^page/([a-zA-Z0-9-]+)/?$ page.php?slug=$1 [L,QSA]

# Redirection des pages d'authentification
RewriteRule ^login/?$ auth/login.php [L]
RewriteRule ^register/?$ auth/register.php [L]
RewriteRule ^logout/?$ auth/logout.php [L]
RewriteRule ^dashboard/?$ dashboard/index.php [L]

# Redirection du panneau d'administration
RewriteRule ^admin/?$ admin/index.php [L]
RewriteRule ^admin/(.*)$ admin/$1 [L]

# Protection contre l'accès direct aux fichiers sensibles
<Files ~ "^\.">
    Order allow,deny
    Deny from all
</Files>

<Files ~ "\.sql$">
    Order allow,deny
    Deny from all
</Files>

<Files ~ "\.log$">
    Order allow,deny
    Deny from all
</Files>

<Files ~ "config\.php$">
    Order allow,deny
    Deny from all
</Files>

# Protection du dossier includes
<Directory "includes">
    Order allow,deny
    Deny from all
</Directory>

# Protection du dossier config
<Directory "config">
    Order allow,deny
    Deny from all
</Directory>

# Autoriser l'accès aux assets
<Directory "assets">
    Order allow,deny
    Allow from all
</Directory>

# Autoriser l'accès aux uploads (mais pas l'exécution de scripts)
<Directory "assets/uploads">
    Order allow,deny
    Allow from all
    
    # Empêcher l'exécution de scripts PHP dans les uploads
    <Files ~ "\.php$">
        Order allow,deny
        Deny from all
    </Files>
    
    # Types MIME autorisés pour les uploads
    <FilesMatch "\.(jpg|jpeg|png|gif|webp|pdf)$">
        Order allow,deny
        Allow from all
    </FilesMatch>
</Directory>

# Headers de sécurité
<IfModule mod_headers.c>
    # Protection XSS
    Header always set X-XSS-Protection "1; mode=block"
    
    # Empêcher le MIME sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Protection contre le clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Politique de référent
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy (ajustez selon vos besoins)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self'; frame-ancestors 'self';"
    
    # Cache pour les assets statiques
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000"
        Header set Expires "Thu, 31 Dec 2025 23:59:59 GMT"
    </FilesMatch>
    
    # Pas de cache pour les pages dynamiques
    <FilesMatch "\.(php|html)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# Compression GZIP
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Limiter la taille des uploads
LimitRequestBody 10485760

# Désactiver la signature du serveur
ServerTokens Prod
ServerSignature Off

# Page d'erreur personnalisée
ErrorDocument 404 /404.php
ErrorDocument 403 /403.php
ErrorDocument 500 /500.php

# Empêcher l'accès aux fichiers de sauvegarde et temporaires
<FilesMatch "(\.(bak|config|dist|fla|inc|ini|log|psd|sh|sql|swp)|~)$">
    Order allow,deny
    Deny from all
    Satisfy All
</FilesMatch>

# Protection contre les injections SQL dans les URLs
RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (\<|%3C).*object.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (\<|%3C).*embed.*(\>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} (SELECT|UNION|INSERT|DROP|DELETE|UPDATE|CREATE|ALTER|EXEC) [NC]
RewriteRule ^(.*)$ - [F,L]

# Protection contre les attaques de traversée de répertoire
RewriteCond %{QUERY_STRING} \.\.\/ [NC,OR]
RewriteCond %{QUERY_STRING} \.\.\\ [NC,OR]
RewriteCond %{QUERY_STRING} \/\.\.\/ [NC,OR]
RewriteCond %{QUERY_STRING} \\\.\.\\  [NC]
RewriteRule ^(.*)$ - [F,L]

# Bloquer les user agents suspects
RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
RewriteCond %{HTTP_USER_AGENT} ^(-|\.|') [OR]
RewriteCond %{HTTP_USER_AGENT} ^(.*)(\bLibwwwPerl\b|libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
RewriteCond %{HTTP_USER_AGENT} ^(.*)(360Spider|80legs|Aboundex|Abonti|Acunetix|ADmantX|AfD-Verifier|AhrefsBot|AIBOT|AiHitBot|Aipbot|Alexibot|Alligator|AllSubmitter|AlphaBot|Anarchie|Apexoo|APIkeyBot|Arachmo|Aspiegel|Asterias|Attach|BackDoorBot|BackWeb|Badass|Bandit|Barkrowler|BatchFTP|Battleztar|BBBike|BBDB|BDCbot|BDFetch|BetaBot|BigBozz|Bitacle|Blackboard|BlackWidow|BLEXBot|Blow|BlowFish|Boardreader|Bolt|BotALot|Brandprotect|Brandwatch|Buck|Buddy|BuiltBotTough|BuiltWith|Bullseye|BunnySlippers|BuzzSumo|Calculon|CATExplorador|CazoodleBot|CCBot|Cegbfeieh|CheeseBot|CherryPicker|ChinaClaw|Chlooe|Claritybot|Cliqzbot|Cloud|Codenamed|Collector|CommaFeed|CompSpyBot|ContentSmartz|Copier|CopyRightCheck|Cosmos|Craftbot|Crawling|CrazyWebCrawler|Crescent|CrunchBot|CSHttp|Curious|Custo|DatabaseDriverMysqli|DataCha0s|DBLBot|demandbase|Demon|Deusu|Devil|Diablo|Digincore|DigitalPebble|DIIbot|DISCo|DittoSpyder|DnyzBot|DomainAppender|DomainCrawler|DomainSigmaCrawler|DomainStatsBot|Dotbot|Download|Downloader|Download\ Demon|Download\ Devil|Download\ Wonder|Dragonfly|Drip|DTS|EasouSpider|eCatch|ECCP|Echo|EirGrabber|EmailCollector|EmailSiphon|EmailWolf|EroCrawler|Evil|Exabot|Express\ WebPictures|ExtLinksBot|Extractor|ExtractorPro|EyeNetIE|Ezooms|F2S|FairAd|Fasterfox|FatBot|FDSE|FeedBooster|Feeble|FeedReader|FeedFinder|FeedGrabber|FeedShark|FetchBlaster|Fimap|FindLinks|FlashGet|FlickBot|Flunky|Foobot|G00g1e|Gaisbot|GalaxyBot|Genieo|GermCrawler|GetRight|GetWeb|Gigablast|Gigabot|G-i-g-a-b-o-t|Go-Ahead-Got-It|GrabNet|Grafula|GrapeshotCrawler|GridBot|GT::WWW|GTB5|Guzzle|Harvest|Heritrix|HMView|HomePageBot|HTTP::Lite|HTTrack|HuaweiSymantecSpider|HyperEstraier|ia_archiver|IDBot|Id-search|IlseBot|Image\ Stripper|Image\ Sucker|Indy\ Library|InfoNaviRobot|InfoTekies|Intelliseek|InterGET|Internet\ Ninja|InternetSeer|internetVista|IPiumBot|IRLbot|ISC\ Systems\ iRc\ Search\ 2\.1|JamesBOT|Jbrofuzz|JennyBot|JetCar|Jiffy|JikesRTS|JOC\ Web\ Spider|Joomla|Jorgee|JustView|Jyxobot|Kenjin|Keyword\ Density|Kinza|Kosmix|Lanshanbot|Larbin|LeechFTP|LeechGet|LexiBot|Lftp|LibWeb|Likse|LinkextractorPro|LinkpadBot|LinkScan|LinksManager|LinkWalker|LinqiaMetadataDownloaderBot|LivelapBot|Loader|Looksmart|Lorkoz|lwp-trivial|Lycos|Mag-Net|Magnet|magpie-crawler|Mail.RU_Bot|masscan|Mass\ Downloader|maverick|Meanpathbot|Metauri|MFC_Tear_Sample|Microsoft\ URL\ Control|MIDown\ tool|miner|Mister\ PiX|mizzu-labs|MJ12bot|Mobile\ Safari|Mojeek|Morfeus\ Fucking\ Scanner|MSFrontPage|MSIECrawler|Msrabot|Musobot|Name\ Intelligence|Nameprotect|Navroad|NearSite|Needle|Nessus|NetAnts|Netcraft|netEstate\ NE\ Crawler|NetMechanic|NetSpider|Nettrack|Net\ Vampire|Netvibes|NetZIP|NextGenSearchBot|NICErsPRO|Niki-bot|NimbleCrawler|Ninja|Nmap|NPbot|Nutch|oBot|Octopus|Offline\ Explorer|Offline\ Navigator|OnCrawl|Openfind|OpenindexSpider|OpenLinkProfiler|Openvas|OrangeBot|OrangeSpider|OutclicksBot|OutfoxBot|PageAnalyzer|PageGrabber|page\ scorer|PageScorer|Pandalytics|Panscient|Papa\ Foto|Pavuk|pcBrowser|PECL::HTTP|PeoplePal|Petalbot|PHPCrawl|Picscout|Picsearch|PictureFinder|Piepmatz|Pimonster|Pixray|PleaseCrawl|plumanalytics|Pockey|POE-Component-Client-HTTP|Probethenet|ProPowerBot|ProWebWalker|Psbot|Pump|PWTechnology|python-requests|Python-urllib|QueryN\ Metasearch|Quick-Crawler|RankActive|RankActiveLinkBot|RankFlex|RankingBot|RankingBot2|Rankivabot|RankurBot|RealDownload|Reaper|RebelMouse|Recorder|RedesScrapy|ReGet|RepoMonkey|Ripper|RocketCrawler|Rogerbot|SBIder|Scrapy|Screaming|ScreenerBot|ScriptedRetriever|searchestate|SearchmetricsBot|Seekport|SEMBOT|SemrushBot|SEOkicks-Robot|SEOlyticsCrawler|Seomoz|SEOprofiler|seoscanners|SeoSiteCheckup|SEOstats|serpstatbot|sexsearcher|Shodan|Siphon|SISTRIX|sitecheck\.internetseer\.com|SiteSnagger|SiteSucker|Sitevigil|SlySearch|SmartDownload|Snake|Snapbot|Snoopy|SocialGrabber|Sogou|Sosospider|Sottopop|SpaceBison|Spammen|SpankBot|Spanner|Spbot|Spinn3r|SputnikBot|Sqlmap|Squider|Steeler|Stripper|Sucker|Sucuri|SuperBot|SuperHTTP|Surfbot|SurveyBot|Suzuran|Swiftbot|sysscan|Szukacz|T0PHackTeam|T8Abot|tAkeOut|Teleport\ Pro|TeleportPro|Telesoft|Telesphoreo|Telesphorep|The\ Intraformant|TheNomad|TightTwatBot|Titan|Toata|Toweyabot|Tracemyfile|Trendictionbot|True_Robot|Turingos|TurnitinBot|TwengaBot|Twice|Typhoeus|UnisterBot|Upflow|URLy\.Warning|URLy\ Warning|Vacuum|Vagabondo|VB\ Project|VCI|VeriCiteCrawler|VidibleScraper|Virusdie|Voidbot|Voil|Voltron|Wallpapers/3.0|WASALive-Bot|WBSearchBot|Webalta|WebAuto|WebBandit|WebCollage|WebCopier|WebFetch|WebGo\ IS|WebLeacher|WebmasterWorldForumBot|webmeup-crawler|WebPix|WebReaper|WebSauger|Website\ eXtractor|Website\ Quester|WebStripper|WebSucker|WebWhacker|WebZIP|Werdbot|Whack|Whacker|Whatweb|WHO\.IS|Widow|WinHTTrack|WizardBot|woobot|woorank|WordupInfoSearch|WWW-Mechanize|WWWOFFLE|x09Mozilla|x22Mozilla|Xaldon_WebSpider|Xenu|xpymep1.exe|YoudaoBot|Zade|Zauba|zauba\.com|Zermelo|Zeus|zgrab|Zitebot|ZmEu|ZumBot|ZyBorg) [NC]
RewriteRule ^(.*)$ - [F,L]

# Limiter le taux de requêtes (si mod_evasive est installé)
<IfModule mod_evasive24.c>
    DOSHashTableSize    2048
    DOSPageCount        10
    DOSSiteCount        100
    DOSPageInterval     1
    DOSSiteInterval     1
    DOSBlockingPeriod   3600
</IfModule>

# Optimisations diverses
Options -Indexes
Options -MultiViews

# Définir la page d'index par défaut
DirectoryIndex index.php index.html

# Empêcher l'affichage des erreurs PHP en production
php_flag display_errors Off
php_flag log_errors On
php_value error_log /var/log/php_errors.log

# Configuration PHP pour les uploads
php_value upload_max_filesize 10M
php_value post_max_size 10M
php_value max_file_uploads 20
php_value memory_limit 256M
php_value max_execution_time 60

# Activer la compression PHP
php_flag zlib.output_compression On

# Configuration de session sécurisée
php_flag session.cookie_httponly On
php_flag session.cookie_secure Off
php_flag session.use_strict_mode On
php_value session.cookie_samesite Strict